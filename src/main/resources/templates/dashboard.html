<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ISMS Dashboard</title>
    <link rel="stylesheet" href="/css/auth.css" />
</head>

<body>

    <!-- Top Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand">
            <span style="color:var(--text-muted); margin-right:6px;">//</span> ISMS
        </div>

        <!-- Role-specific links injected here -->
        <div class="nav-menu" id="navMenu"></div>

        <div class="nav-user">
            <div id="userRoleBadge" class="user-badge">Loading...</div>
            <button id="logoutBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px;">Logout</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main-container">
        <!-- Flash Message Area -->
        <div id="msg" class="message hidden" role="status" aria-live="polite"></div>

        <!-- 
             TAB: Data Import (Admin Only)
             Contains: Student/Faculty CSV & Single Add Forms
        -->
        <div id="view-import" class="tab-content hidden">
            <div class="grid-2">
                <!-- Students Group -->
                <div>
                    <div class="card-panel">
                        <h3 class="card-title">Import Students CSV</h3>
                        <form id="studentsForm">
                            <div class="form-group">
                                <input class="input" id="studentsFile" type="file" accept=".csv,text/csv" required />
                            </div>
                            <button class="btn" type="submit">Upload List</button>
                        </form>
                    </div>
                    <div class="card-panel">
                        <h3 class="card-title">Add Single Student</h3>
                        <form id="singleStudentForm">
                            <div class="form-group">
                                <label class="label">Full Name</label>
                                <input class="input" id="studentName" type="text" required />
                            </div>
                            <div class="grid-2" style="margin-bottom:12px;">
                                <div>
                                    <label class="label">DOB</label>
                                    <input class="input" id="studentDob" type="date" required />
                                </div>
                                <div>
                                    <label class="label">Email</label>
                                    <input class="input" id="studentEmail" type="email" required />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="label">Status</label>
                                <select class="input" id="studentStatus" required>
                                    <option value="PENDING">Pending</option>
                                    <option value="ACTIVELY_STUDYING">Active</option>
                                    <option value="COMPLETED_STUDY">Completed</option>
                                </select>
                            </div>
                            <button class="btn" type="submit">Save Student</button>
                        </form>
                    </div>
                </div>

                <!-- Faculty Group -->
                <div>
                    <div class="card-panel">
                        <h3 class="card-title">Import Faculty CSV</h3>
                        <form id="facultiesForm">
                            <div class="form-group">
                                <input class="input" id="facultiesFile" type="file" accept=".csv,text/csv" required />
                            </div>
                            <button class="btn" type="submit">Upload List</button>
                        </form>
                    </div>
                    <div class="card-panel">
                        <h3 class="card-title">Add Single Faculty</h3>
                        <form id="singleFacultyForm">
                            <div class="form-group">
                                <label class="label">Full Name</label>
                                <input class="input" id="facultyName" type="text" required />
                            </div>
                            <div class="form-group">
                                <label class="label">Email</label>
                                <input class="input" id="facultyEmail" type="email" required />
                            </div>
                            <div class="grid-2" style="margin-bottom:12px;">
                                <div>
                                    <label class="label">Department</label>
                                    <select class="input" id="facultyDepartment" required>
                                        <option value="CSE">CSE</option>
                                        <option value="ECE">ECE</option>
                                        <option value="IT">IT</option>
                                        <option value="AIML">AIML</option>
                                        <option value="MECHANICAL">MECHANICAL</option>
                                        <option value="CIVIL">CIVIL</option>
                                        <option value="EEE">EEE</option>
                                        <option value="BIOMEDICAL">BIOMEDICAL</option>
                                        <option value="PRODUCTION">PRODUCTION</option>
                                        <option value="AUTOMOBILE">AUTOMOBILE</option>
                                        <option value="TEXTILE">TEXTILE</option>
                                        <option value="FASHION">FASHION</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label">Role</label>
                                    <select class="input" id="facultyDesignation" required>
                                        <option value="PROFESSOR">Professor</option>
                                        <option value="ASSOCIATE_PROFESSOR">Assoc. Prof</option>
                                        <option value="ASSISTANT_PROFESSOR">Asst. Prof</option>
                                        <option value="HOD">HOD</option>
                                        <option value="DEAN">Dean</option>
                                        <option value="PRINCIPAL">Principal</option>
                                        <option value="LECTURER">Lecturer</option>
                                        <option value="LAB_ASSISTANT">Lab Asst</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn" type="submit">Save Faculty</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 
             TAB: Course Administration (Admin Only)
             Contains: Add Course Form + Course Table
        -->
        <div id="view-course-admin" class="tab-content hidden">
            <!-- Add Course -->
            <div class="card-panel">
                <h3 class="card-title">Create New Course</h3>
                <form id="addCourseForm" style="display:flex; gap:12px; align-items:flex-end;">
                    <div style="flex:2;">
                        <label class="label">Course Name</label>
                        <input class="input" id="courseName" type="text" placeholder="e.g. Adv. Algorithms" required />
                    </div>
                    <div style="flex:1;">
                        <label class="label">Code</label>
                        <input class="input" id="courseCode" type="text" placeholder="CS202" required />
                    </div>
                    <div style="flex:1;">
                        <label class="label">Credits</label>
                        <input class="input" id="courseCredits" type="number" min="1" max="10" placeholder="4"
                            required />
                    </div>
                    <button class="btn" type="submit">Create</button>
                </form>
            </div>

            <!-- Course Table -->
            <div class="card-panel" style="padding:0; border:none; background:transparent;">
                <h3 class="card-title" style="margin-bottom:12px;">Existing Courses</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width:100px;">Code</th>
                                <th>Course Name</th>
                                <th style="width:80px;">Credits</th>
                                <th style="width:140px; text-align:right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="courseAdminBody">
                            <tr>
                                <td colspan="4" style="text-align:center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 
             TAB: List of Courses (Faculty/Student)
             ReadOnly Table
        -->
        <div id="view-courses" class="tab-content hidden">
            <div class="card-panel">
                <h2 class="card-title">List of Courses</h2>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width:120px;">Course Code</th>
                                <th>Course Name</th>
                                <th style="width:80px;">Credits</th>
                            </tr>
                        </thead>
                        <tbody id="coursePublicBody">
                            <tr>
                                <td colspan="3" style="text-align:center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        const TOKEN_KEY = 'isms.jwt';

        // Elements
        const msg = document.getElementById('msg');
        const userRoleBadge = document.getElementById('userRoleBadge');
        const navMenu = document.getElementById('navMenu');

        // State
        let CURRENT_ROLE = 'STUDENT';

        // Auth Helpers
        function token() { return localStorage.getItem(TOKEN_KEY); }
        function decodeJwt(jwt) {
            try { return JSON.parse(atob(jwt.split('.')[1].replace(/-/g, '+').replace(/_/g, '/'))); }
            catch { return null; }
        }
        function getRoles(jwt) {
            const p = decodeJwt(jwt);
            return (p && p.scope) ? p.scope.split(' ').filter(Boolean) : [];
        }
        function requireAuth() { if (!token()) window.location.replace('/login'); }

        // UI Helpers
        function showMessage(text, type) {
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.hidden = false;
        }

        // --- View Logic ---
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

            // Show target
            const target = document.getElementById(`view-${tabId}`);
            if (target) target.classList.remove('hidden');

            // Update Nav Active State
            document.querySelectorAll('.nav-item').forEach(el => {
                if (el.dataset.tab === tabId) el.classList.add('active');
                else el.classList.remove('active');
            });

            // Special Loaders
            if (tabId === 'course-admin' || tabId === 'courses') loadCourses();
        }

        function renderNav(role) {
            let links = [];

            // "make a nav bar for each" + "data import" + "course administration"
            if (role === 'ADMIN') {
                links = [
                    { label: 'Data Import', id: 'import' },
                    { label: 'Course Administration', id: 'course-admin' }
                ];
            } else {
                // Faculty or Student -> "List of courses"
                links = [
                    { label: 'List of Courses', id: 'courses' }
                ];
            }

            navMenu.innerHTML = links.map(l =>
                `<div class="nav-item" data-tab="${l.id}" onclick="switchTab('${l.id}')">${l.label}</div>`
            ).join('');

            // Activate first tab
            if (links.length > 0) switchTab(links[0].id);
        }

        // --- Init ---
        function init() {
            requireAuth();
            const jwt = token();
            const roles = getRoles(jwt);

            if (roles.includes('ROLE_ADMIN')) {
                CURRENT_ROLE = 'ADMIN';
                userRoleBadge.textContent = 'Administrator';
                userRoleBadge.style.color = '#fcb_00';
                userRoleBadge.style.borderColor = 'rgba(255, 200, 0, 0.4)';
            } else if (roles.includes('ROLE_FACULTY')) {
                CURRENT_ROLE = 'FACULTY';
                userRoleBadge.textContent = 'Faculty';
                userRoleBadge.style.color = '#6ee7b7';
            } else {
                CURRENT_ROLE = 'STUDENT';
                userRoleBadge.textContent = 'Student';
            }

            renderNav(CURRENT_ROLE);
        }

        // --- API Calls ---
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const opts = {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token()}`,
                        ...(body ? { 'Content-Type': 'application/json' } : {})
                    }
                };
                if (body instanceof FormData) {
                    delete opts.headers['Content-Type'];
                    opts.body = body;
                } else if (body) {
                    opts.body = JSON.stringify(body);
                }

                const res = await fetch(endpoint, opts);
                if (res.status === 401) {
                    localStorage.removeItem(TOKEN_KEY);
                    window.location.replace('/login');
                    return null;
                }
                const text = await res.text();
                return { ok: res.ok, text };
            } catch (e) {
                return { ok: false, text: 'Network Error' };
            }
        }

        // --- Features ---
        async function loadCourses() {
            // Determine active table based on role
            const isAdmin = (CURRENT_ROLE === 'ADMIN');
            const tbody = document.getElementById(isAdmin ? 'courseAdminBody' : 'coursePublicBody');

            if (!tbody) return;

            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--text-muted);">Loading...</td></tr>`;

            const res = await apiCall('/get/courses');
            if (!res || !res.ok) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--danger);">Failed to load</td></tr>`;
                return;
            }

            const courses = JSON.parse(res.text);

            if (courses.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No courses found.</td></tr>`;
                return;
            }

            if (isAdmin) {
                tbody.innerHTML = courses.map(c => `
                    <tr>
                        <td><span style="font-family:monospace; background:#222; padding:2px 6px; border-radius:4px;">${c.courseCode}</span></td>
                        <td style="font-weight:500;">${c.courseName}</td>
                        <td>${c.credits}</td>
                        <td style="text-align:right;">
                            <button class="btn btn-secondary" style="padding:4px 8px; font-size:11px;" 
                                onclick="updateCourse('${c.courseCode}', '${c.courseName}')">Edit</button>
                            <button class="btn btn-danger" style="padding:4px 8px; font-size:11px; margin-left:6px;" 
                                onclick="removeCourse('${c.courseCode}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = courses.map(c => `
                    <tr>
                        <td><span style="font-family:monospace; background:#222; padding:2px 6px; border-radius:4px;">${c.courseCode}</span></td>
                        <td style="font-weight:500;">${c.courseName}</td>
                        <td>${c.credits}</td>
                    </tr>
                `).join('');
            }
        }

        // Forms Config
        const forms = {
            studentsForm: { url: '/students/csv', type: 'file', fileId: 'studentsFile' },
            facultiesForm: { url: '/faculties/csv', type: 'file', fileId: 'facultiesFile' },
            singleStudentForm: { url: '/student/csv', type: 'json', fields: ['studentName', 'studentDob', 'studentEmail', 'studentStatus'], map: { studentName: 'name', studentDob: 'dateOfBirth', studentEmail: 'email', studentStatus: 'enrolmentStatus' } },
            singleFacultyForm: { url: '/faculty/csv', type: 'json', fields: ['facultyName', 'facultyEmail', 'facultyDepartment', 'facultyDesignation'], map: { facultyName: 'name', facultyEmail: 'email', facultyDepartment: 'department', facultyDesignation: 'designation' } },
            addCourseForm: { url: '/post/course', type: 'json', fields: ['courseName', 'courseCode', 'courseCredits'], map: { courseCredits: (v) => parseInt(v) }, success: loadCourses }
        };

        // Attach Listeners
        Object.entries(forms).forEach(([id, config]) => {
            const el = document.getElementById(id);
            if (!el) return;

            el.addEventListener('submit', async (e) => {
                e.preventDefault();
                msg.hidden = true;
                let body;

                if (config.type === 'file') {
                    const input = document.getElementById(config.fileId);
                    if (!input.files[0]) return showMessage('Select file first', 'error');
                    body = new FormData();
                    body.append('file', input.files[0]);
                } else {
                    body = {};
                    config.fields.forEach(f => {
                        const val = document.getElementById(f).value;
                        let finalVal = val;
                        let finalKey;

                        for (let k in config.map) {
                            if (k === f) {
                                if (typeof config.map[k] === 'function') finalVal = config.map[k](val);
                                else finalKey = config.map[k];
                            }
                        }
                        if (!finalKey) finalKey = config.map[f] || f;

                        body[finalKey] = finalVal;
                    });
                }

                const res = await apiCall(config.url, 'POST', body);
                showMessage(res.text, res.ok ? 'success' : 'error');
                if (res.ok) {
                    el.reset();
                    if (config.success) config.success();
                }
            });
        });

        // Global Actions
        window.updateCourse = async (code, oldName) => {
            const newName = prompt('New Course Name:', oldName);
            if (newName && newName !== oldName) {
                const res = await apiCall(`/update/course?courseName=${encodeURIComponent(newName)}&courseCode=${encodeURIComponent(code)}`, 'PUT');
                showMessage(res.text, res.ok ? 'success' : 'error');
                if (res.ok) loadCourses();
            }
        }

        window.removeCourse = async (code) => {
            if (confirm('Delete course ' + code + '?')) {
                const res = await apiCall(`/delete/course?courseCode=${encodeURIComponent(code)}`, 'DELETE');
                showMessage(res.text, res.ok ? 'success' : 'error');
                if (res.ok) loadCourses();
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem(TOKEN_KEY);
            window.location.replace('/login');
        });

        init();
    </script>
</body>

</html>